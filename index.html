<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Sentience ‚Äî Your Financial Conscience</title>
  <meta name="description" content="Sentience ‚Äî AI that understands the emotional side of your spending."/>
  <!-- Zero external fonts. Zero animations. Zero backdrop-filter. -->
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0d1117;--bg2:#161b22;--bg3:#1c2128;--bg4:#21262d;
      --accent:#10b981;--accent-h:#0ea271;
      --accent-s:rgba(16,185,129,.12);--accent-b:rgba(16,185,129,.22);
      --b1:rgba(255,255,255,.07);--b2:rgba(255,255,255,.12);--b3:rgba(255,255,255,.18);
      --t1:#e6edf3;--t2:#8b949e;--t3:#6e7681;
      --red:#f87171;--amber:#fbbf24;--blue:#60a5fa;--purple:#a78bfa;
      --r:10px;--rl:14px;--rxl:20px;
      --sans:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
      --mono:'SF Mono','Cascadia Code','Fira Code',Consolas,'Courier New',monospace;
      --hist-w:220px;--side-w:280px;
    }
    html,body{height:100%;overflow:hidden}
    body{background:var(--bg);color:var(--t1);font-family:var(--sans);
         font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}

    .skip-link{position:absolute;top:-100%;left:14px;background:var(--accent);
               color:#fff;padding:8px 14px;border-radius:var(--r);font-size:13px;
               font-weight:500;z-index:9999;transition:top .15s}
    .skip-link:focus{top:14px}

    .shell{display:flex;flex-direction:column;height:100vh;overflow:hidden}

    /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
    header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
           padding:0 20px;height:52px;border-bottom:1px solid var(--b1);background:var(--bg)}

    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:28px;height:28px;background:var(--accent);border-radius:7px;
               display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .logo-icon svg{width:15px;height:15px}
    .logo-name{font-size:16px;font-weight:700;letter-spacing:-.02em;color:var(--t1)}
    .logo-tagline{font-size:11px;color:var(--t3);margin-left:4px}
    .logo-badge{font-family:var(--mono);font-size:10px;color:var(--accent);
                background:var(--accent-s);border:1px solid var(--accent-b);
                padding:2px 8px;border-radius:100px;letter-spacing:.06em;text-transform:uppercase}

    .hdr-r{display:flex;align-items:center;gap:8px}
    .status-pill{display:flex;align-items:center;gap:6px;background:var(--bg2);
                 border:1px solid var(--b1);border-radius:100px;padding:4px 12px;
                 font-family:var(--mono);font-size:11px;color:var(--t2);
                 transition:border-color .15s,color .15s}
    .status-pill.online{border-color:var(--accent-b);color:var(--accent)}
    .status-pill.offline{border-color:rgba(248,113,113,.3);color:var(--red)}
    .sdot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}

    /* ‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê */
    main{flex:1;min-height:0;display:flex;overflow:hidden}

    /* ‚ïê‚ïê‚ïê HISTORY SIDEBAR ‚ïê‚ïê‚ïê */
    .hist-sidebar{width:var(--hist-w);flex-shrink:0;display:flex;flex-direction:column;
                  border-right:1px solid var(--b1);background:var(--bg);overflow:hidden}
    @media(max-width:900px){.hist-sidebar{display:none}}
    .hist-top{flex-shrink:0;padding:12px;border-bottom:1px solid var(--b1)}
    .hist-heading{font-size:10px;font-weight:700;text-transform:uppercase;
                  letter-spacing:.1em;color:var(--t3);margin-bottom:8px}
    .new-chat-btn{display:flex;align-items:center;justify-content:center;gap:7px;
                  width:100%;padding:7px 12px;border-radius:var(--r);
                  border:1px solid var(--b2);background:transparent;
                  color:var(--t2);font-size:12px;font-weight:500;font-family:var(--sans);
                  cursor:pointer;transition:background .15s,color .15s,border-color .15s}
    .new-chat-btn:hover{background:var(--bg3);color:var(--t1);border-color:var(--b3)}
    .new-chat-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .hist-list{flex:1;overflow-y:auto;padding:6px}
    .hist-list::-webkit-scrollbar{width:3px}
    .hist-list::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
    .hist-date-label{font-size:10px;font-weight:600;text-transform:uppercase;
                     letter-spacing:.08em;color:var(--t3);padding:8px 8px 4px}
    .hist-item{display:flex;flex-direction:column;padding:8px 10px;border-radius:var(--r);
               cursor:pointer;border:1px solid transparent;margin-bottom:1px;
               transition:background .12s,border-color .12s}
    .hist-item:hover{background:var(--bg3);border-color:var(--b1)}
    .hist-item.active{background:var(--accent-s);border-color:var(--accent-b)}
    .hist-item:focus-visible{outline:2px solid var(--accent);outline-offset:1px}
    .hi-title{font-size:12px;font-weight:500;color:var(--t1);
              white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hist-item.active .hi-title{color:var(--accent)}
    .hi-meta{font-family:var(--mono);font-size:10px;color:var(--t3);margin-top:2px}
    .hist-empty{padding:20px 10px;text-align:center;font-size:12px;color:var(--t3);line-height:1.7}

    /* ‚ïê‚ïê‚ïê CHAT PANEL ‚ïê‚ïê‚ïê */
    .chat-panel{flex:1;min-width:0;display:flex;flex-direction:column;
                min-height:0;border-right:1px solid var(--b1)}
    .chat-titlebar{flex-shrink:0;height:42px;padding:0 20px;
                   border-bottom:1px solid var(--b1);background:var(--bg);
                   display:flex;align-items:center;gap:10px}
    .chat-session-title{font-size:13px;font-weight:600;color:var(--t1);
                        white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
    .chat-session-id{font-family:var(--mono);font-size:10px;color:var(--t3);
                     background:var(--bg3);border:1px solid var(--b1);
                     padding:2px 7px;border-radius:100px;flex-shrink:0}

    /* Ledger tab row */
    .tab-row{flex-shrink:0;display:flex;border-bottom:1px solid var(--b1);background:var(--bg)}
    .tab-btn{padding:0 18px;height:38px;font-size:12px;font-weight:500;
             font-family:var(--sans);cursor:pointer;border:none;background:transparent;
             color:var(--t3);border-bottom:2px solid transparent;
             transition:color .15s,border-color .15s}
    .tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-btn:hover:not(.active){color:var(--t1)}
    .tab-btn:focus-visible{outline:2px solid var(--accent);outline-offset:-2px}

    /* Tab panels */
    .tab-panel{display:none;flex:1;min-height:0;flex-direction:column}
    .tab-panel.show{display:flex}

    /* Chat area */
    #chatArea{flex:1;min-height:0;overflow-y:auto;padding:20px;
              display:flex;flex-direction:column;gap:14px}
    #chatArea::-webkit-scrollbar{width:4px}
    #chatArea::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}

    /* Empty state */
    .empty-state{flex:1;display:flex;flex-direction:column;align-items:center;
                 justify-content:center;gap:14px;text-align:center;padding:2rem;color:var(--t2)}
    .empty-icon{width:56px;height:56px;border-radius:50%;background:var(--accent-s);
                border:1px solid var(--accent-b);display:flex;align-items:center;justify-content:center}
    .empty-icon svg{width:24px;height:24px;color:var(--accent)}
    .empty-state h2{font-size:17px;font-weight:600;color:var(--t1)}
    .empty-state p{font-size:13px;max-width:260px;line-height:1.7}

    /* Messages */
    .msg-block{display:flex;flex-direction:column;max-width:70ch}
    .msg-block.user{align-items:flex-end;align-self:flex-end}
    .msg-block.ai,.msg-block.safety,.msg-block.proactive,.msg-block.intervention
      {align-items:flex-start;align-self:flex-start}
    .msg-label{font-size:10px;font-weight:600;color:var(--t3);margin-bottom:4px;
               padding:0 4px;letter-spacing:.02em;text-transform:uppercase}
    .msg-block.user .msg-label{color:var(--accent)}
    .msg-block.intervention .msg-label{color:var(--amber)}
    .msg-bubble{font-size:14px;line-height:1.65;border-radius:var(--rl);
                padding:11px 15px;word-break:break-word}
    .msg-block.user .msg-bubble{background:var(--bg3);border:1px solid var(--b3);
                                color:var(--t1);border-bottom-right-radius:4px}
    .msg-block.ai .msg-bubble{background:var(--bg2);border:1px solid var(--accent-b);
                              color:var(--t1);border-bottom-left-radius:4px;
                              border-left:2px solid var(--accent)}
    .msg-block.intervention .msg-bubble{background:rgba(251,191,36,.07);
                                        border:1px solid rgba(251,191,36,.22);
                                        color:var(--t1);border-bottom-left-radius:4px;
                                        border-left:2px solid var(--amber)}
    .msg-block.safety .msg-bubble{background:rgba(248,113,113,.07);
                                  border:1px solid rgba(248,113,113,.2);
                                  color:var(--t1);border-bottom-left-radius:4px;
                                  border-left:2px solid var(--red)}
    .msg-block.proactive .msg-bubble{background:rgba(96,165,250,.07);
                                     border:1px solid rgba(96,165,250,.2);
                                     color:var(--t1);border-bottom-left-radius:4px;
                                     border-left:2px solid var(--blue)}
    .emo-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;
               font-family:var(--mono);color:var(--accent);background:var(--accent-s);
               border:1px solid var(--accent-b);padding:2px 7px;border-radius:100px;margin-top:5px}
    .msg-meta{font-family:var(--mono);font-size:10px;color:var(--t3);
              margin-top:4px;padding:0 4px}
    .msg-block.user .msg-meta{text-align:right}
    .hist-divider{display:flex;align-items:center;gap:10px;font-size:10px;
                  font-family:var(--mono);color:var(--t3);padding:4px 0}
    .hist-divider::before,.hist-divider::after{content:'';flex:1;height:1px;background:var(--b1)}
    .typing-block{display:flex;flex-direction:column;align-items:flex-start}
    .typing-label{font-size:10px;font-weight:600;text-transform:uppercase;
                  letter-spacing:.02em;color:var(--t3);margin-bottom:4px;padding:0 4px}
    .typing-bub{background:var(--bg2);border:1px solid var(--b2);
                border-left:2px solid var(--accent);border-radius:var(--rl);
                border-bottom-left-radius:4px;padding:12px 16px;
                display:flex;gap:5px;align-items:center}
    .typing-bub span{width:6px;height:6px;background:var(--accent);border-radius:50%}
    .typing-bub span:nth-child(1){opacity:.4}
    .typing-bub span:nth-child(2){opacity:.7}
    .typing-bub span:nth-child(3){opacity:1}

    /* ‚ïê‚ïê‚ïê LEDGER TAB ‚ïê‚ïê‚ïê */
    .ledger-panel{flex:1;min-height:0;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:18px}
    .ledger-panel::-webkit-scrollbar{width:4px}
    .ledger-panel::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}

    .ledger-card{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--rl);padding:16px}
    .lc-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;
              color:var(--t3);margin-bottom:12px}
    .lc-narrative{font-size:13px;color:var(--t1);line-height:1.65;
                  border-left:2px solid var(--accent);padding-left:12px;font-style:italic}

    /* Summary row */
    .sum-row{display:flex;gap:10px}
    .sum-card{flex:1;background:var(--bg3);border:1px solid var(--b1);
              border-radius:var(--r);padding:12px;text-align:center}
    .sum-num{font-size:20px;font-weight:700;color:var(--accent);line-height:1}
    .sum-lbl{font-size:10px;font-family:var(--mono);color:var(--t3);margin-top:4px}

    /* Emotion bar chart */
    .chart-wrap{display:flex;flex-direction:column;gap:8px}
    .chart-row{display:flex;align-items:center;gap:10px}
    .chart-label{font-size:12px;color:var(--t2);width:90px;flex-shrink:0;text-align:right;
                 white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chart-bar-bg{flex:1;height:22px;background:var(--bg3);border-radius:4px;overflow:hidden;
                  border:1px solid var(--b1);position:relative}
    .chart-bar-fill{height:100%;border-radius:4px;transition:width .4s ease;min-width:4px}
    .chart-bar-text{position:absolute;right:8px;top:50%;transform:translateY(-50%);
                    font-size:11px;font-family:var(--mono);color:var(--t2)}
    .chart-count{font-size:10px;font-family:var(--mono);color:var(--t3);
                 width:50px;flex-shrink:0;text-align:left}

    /* Category bar */
    .cat-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .cat-label{font-size:12px;color:var(--t2);width:110px;flex-shrink:0;
               white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cat-bar-bg{flex:1;height:14px;background:var(--bg3);border-radius:3px;overflow:hidden}
    .cat-bar-fill{height:100%;border-radius:3px;background:var(--blue)}
    .cat-amt{font-size:11px;font-family:var(--mono);color:var(--t3);width:60px;text-align:right}

    /* Recent spends table */
    .spend-table{width:100%;border-collapse:collapse}
    .spend-table th{font-size:10px;text-transform:uppercase;letter-spacing:.06em;
                    color:var(--t3);font-weight:600;padding:6px 8px;
                    border-bottom:1px solid var(--b1);text-align:left}
    .spend-table td{font-size:12px;padding:8px;border-bottom:1px solid var(--b1);color:var(--t2)}
    .spend-table tr:last-child td{border-bottom:none}
    .spend-table tr:hover td{background:var(--bg3);color:var(--t1)}
    .regret-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}
    .regret-ask-btn{background:none;border:1px solid var(--b1);border-radius:6px;
                    padding:2px 7px;font-size:10px;cursor:pointer;color:var(--t3);
                    font-family:var(--sans);transition:border-color .12s,color .12s}
    .regret-ask-btn:hover{border-color:var(--b2);color:var(--t1)}

    /* Empty ledger */
    .ledger-empty{flex:1;display:flex;flex-direction:column;align-items:center;
                  justify-content:center;gap:12px;color:var(--t3);text-align:center;padding:40px}
    .ledger-empty p{font-size:13px;max-width:240px;line-height:1.7}

    /* ‚ïê‚ïê‚ïê INPUT BAR ‚ïê‚ïê‚ïê */
    .input-bar{flex-shrink:0;background:var(--bg);border-top:1px solid var(--b2);padding:12px 16px}
    .voice-ind{display:none;align-items:center;gap:8px;margin-bottom:8px;padding:7px 12px;
               background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);
               border-radius:var(--r);font-family:var(--mono);font-size:11px;color:var(--red)}
    .voice-ind.on{display:flex}
    .tone-row{display:flex;align-items:center;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none}
    .tone-row::-webkit-scrollbar{display:none}
    .tone-label{font-size:11px;font-weight:600;color:var(--t2);white-space:nowrap;flex-shrink:0}
    .tone-chip{display:flex;align-items:center;gap:4px;padding:4px 11px;border-radius:100px;
               border:1px solid var(--b1);background:var(--bg2);color:var(--t2);
               font-size:12px;font-weight:500;font-family:var(--sans);cursor:pointer;
               white-space:nowrap;flex-shrink:0;transition:background .12s,border-color .12s,color .12s}
    .tone-chip:hover{background:var(--bg3);border-color:var(--b2);color:var(--t1)}
    .tone-chip.active{background:var(--accent-s);border-color:var(--accent-b);color:var(--accent)}
    .tone-chip:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .inp-row{display:flex;gap:8px;align-items:flex-end}
    #userInput{flex:1;background:var(--bg2);border:1px solid var(--b2);border-radius:var(--rxl);
               color:var(--t1);font-family:var(--sans);font-size:14px;padding:11px 16px;
               resize:none;min-height:46px;max-height:120px;line-height:1.55;
               transition:border-color .15s;-webkit-appearance:none}
    #userInput::placeholder{color:var(--t3)}
    #userInput:hover{border-color:var(--b3)}
    #userInput:focus{outline:2px solid var(--accent);outline-offset:-1px;border-color:var(--accent)}
    #micBtn{width:46px;height:46px;border-radius:50%;border:1px solid var(--b2);
            background:var(--bg2);color:var(--t2);cursor:pointer;display:flex;
            align-items:center;justify-content:center;flex-shrink:0;
            transition:background .15s,border-color .15s,color .15s}
    #micBtn:hover{background:var(--bg3);border-color:var(--b3);color:var(--t1)}
    #micBtn.rec{background:rgba(248,113,113,.12);border-color:var(--red);color:var(--red);
                outline:2px solid rgba(248,113,113,.4);outline-offset:2px}
    #micBtn:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
    #sendBtn{height:46px;padding:0 22px;border-radius:var(--rxl);border:none;
             background:var(--accent);color:#fff;font-size:14px;font-weight:600;
             font-family:var(--sans);cursor:pointer;flex-shrink:0;
             transition:background .15s}
    #sendBtn:hover:not(:disabled){background:var(--accent-h)}
    #sendBtn:disabled{opacity:.38;cursor:not-allowed;background:var(--bg4);color:var(--t2)}
    #sendBtn:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
    .tool-row{display:flex;align-items:center;justify-content:space-between;margin-top:9px;padding:0 2px}
    .hint-txt{font-size:11px;color:var(--t3)}
    .cc{font-family:var(--mono);font-size:10px;color:var(--t3)}
    .cc.warn{color:var(--amber)}
    .reset-btn{background:none;border:none;font-size:11px;font-family:var(--sans);
               color:var(--t3);cursor:pointer;display:flex;align-items:center;gap:3px;
               padding:3px 6px;border-radius:6px;transition:color .15s,background .15s}
    .reset-btn:hover{color:var(--amber);background:rgba(251,191,36,.06)}
    .reset-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

    /* ‚ïê‚ïê‚ïê RIGHT SIDEBAR ‚ïê‚ïê‚ïê */
    .right-sidebar{width:var(--side-w);flex-shrink:0;display:flex;flex-direction:column;
                   overflow-y:auto;background:var(--bg);border-left:1px solid var(--b1)}
    .right-sidebar::-webkit-scrollbar{width:3px}
    .right-sidebar::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
    @media(max-width:768px){.right-sidebar{display:none}}
    .rs-sec{padding:14px 16px;border-bottom:1px solid var(--b1)}
    .rs-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;
              color:var(--t3);margin-bottom:12px}

    /* Camera */
    .vis-card{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--rl);overflow:hidden}
    .vis-card-head{display:flex;align-items:center;justify-content:space-between;
                   padding:11px 14px;border-bottom:1px solid var(--b1)}
    .vis-card-title{font-size:13px;font-weight:600;color:var(--t1)}
    .toggle{width:40px;height:22px;border-radius:11px;background:var(--bg4);border:none;
            cursor:pointer;position:relative;transition:background .2s}
    .toggle.on{background:var(--accent)}
    .toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;
                   background:#fff;top:3px;left:3px;
                   transition:transform .2s;will-change:transform}
    .toggle.on::after{transform:translateX(18px)}
    .toggle:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
    .cam-wrap{position:relative;aspect-ratio:4/3;background:var(--bg);overflow:hidden}
    #videoFeed{width:100%;height:100%;object-fit:cover;display:block;
               transform:scaleX(-1);opacity:0;transition:opacity .3s}
    #videoFeed.live{opacity:1}
    .cam-off{position:absolute;inset:0;display:flex;flex-direction:column;
             align-items:center;justify-content:center;gap:8px;background:var(--bg3)}
    .cam-off.gone{display:none}
    .cam-off-icon{color:var(--t3);opacity:.4}
    .cam-off-txt{font-family:var(--mono);font-size:10px;text-transform:uppercase;
                 letter-spacing:.1em;color:var(--t3)}
    .vis-reading{padding:11px 14px}
    .vis-reading-lbl{font-size:10px;font-weight:600;text-transform:uppercase;
                     letter-spacing:.1em;color:var(--t3);margin-bottom:4px}
    .vis-reading-val{font-size:12px;color:var(--t2);font-style:italic;line-height:1.5}
    .vis-reading-val.active{color:var(--accent);font-style:normal}

    /* Emotion orb */
    .emo-row{display:flex;align-items:center;gap:12px}
    .emo-orb{width:48px;height:48px;border-radius:50%;flex-shrink:0;background:var(--bg3);
             border:1px solid var(--b2);display:flex;align-items:center;justify-content:center;
             font-size:22px;transition:border-color .2s,background .2s}
    .emo-orb.detected{background:var(--accent-s);border-color:var(--accent-b)}
    .emo-name{font-size:15px;font-weight:600;color:var(--t1)}
    .emo-sub{font-size:11px;color:var(--t3);margin-top:2px}

    /* Log Spend form */
    .spend-form{display:flex;flex-direction:column;gap:10px}
    .sf-row{display:flex;gap:8px}
    .sf-input{flex:1;background:var(--bg2);border:1px solid var(--b2);border-radius:var(--r);
              color:var(--t1);font-family:var(--sans);font-size:13px;padding:8px 12px;
              transition:border-color .15s;-webkit-appearance:none}
    .sf-input::placeholder{color:var(--t3)}
    .sf-input:hover{border-color:var(--b3)}
    .sf-input:focus{outline:2px solid var(--accent);outline-offset:-1px;border-color:var(--accent)}
    .sf-input.small{width:80px;flex:none}
    select.sf-input{cursor:pointer}
    .log-btn{width:100%;padding:9px;border-radius:var(--r);border:none;
             background:var(--accent);color:#fff;font-size:13px;font-weight:600;
             font-family:var(--sans);cursor:pointer;transition:background .15s}
    .log-btn:hover{background:var(--accent-h)}
    .log-btn:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
    .log-btn:disabled{opacity:.4;cursor:not-allowed}
    .log-feedback{font-size:11px;color:var(--accent);font-style:italic;min-height:16px}

    /* Memory */
    .mem-row{display:flex;gap:8px}
    .mem-card{flex:1;background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);
              padding:12px;text-align:center;transition:border-color .15s}
    .mem-card:hover{border-color:var(--b2)}
    .mem-num{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
    .mem-lbl{font-size:10px;font-family:var(--mono);color:var(--t3);margin-top:4px}

    /* Shortcuts */
    .kbd-list{display:flex;flex-direction:column;gap:8px}
    .kbd-row{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--t2)}
    .keys{display:flex;gap:3px}
    .key{font-family:var(--mono);font-size:10px;background:var(--bg3);border:1px solid var(--b2);
         border-bottom-width:2px;border-radius:4px;padding:2px 6px;color:var(--t2)}

    /* ‚ïê‚ïê‚ïê INTERVENTION MODAL ‚ïê‚ïê‚ïê */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;
                    align-items:center;justify-content:center;padding:20px}
    .modal-backdrop.show{display:flex}
    .modal{background:var(--bg2);border:1px solid rgba(251,191,36,.3);border-radius:var(--rxl);
           padding:28px;max-width:400px;width:100%;}
    .modal-icon{font-size:32px;margin-bottom:12px;display:block}
    .modal-title{font-size:18px;font-weight:700;color:var(--t1);margin-bottom:8px}
    .modal-body{font-size:14px;color:var(--t2);line-height:1.7;margin-bottom:20px}
    .modal-body strong{color:var(--amber)}
    .modal-actions{display:flex;gap:10px}
    .modal-dismiss{flex:1;padding:10px;border-radius:var(--r);border:1px solid var(--b2);
                   background:transparent;color:var(--t2);font-family:var(--sans);
                   font-size:13px;font-weight:500;cursor:pointer;transition:background .15s,color .15s}
    .modal-dismiss:hover{background:var(--bg3);color:var(--t1)}
    .modal-log-anyway{flex:1;padding:10px;border-radius:var(--r);border:none;
                      background:rgba(251,191,36,.15);color:var(--amber);
                      font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;
                      transition:background .15s}
    .modal-log-anyway:hover{background:rgba(251,191,36,.25)}
    .modal-dismiss:focus-visible,.modal-log-anyway:focus-visible
      {outline:2px solid var(--accent);outline-offset:2px}

    /* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
    .phone-bar{display:none;flex-shrink:0;padding:8px 16px;background:var(--bg);
               border-top:1px solid var(--b1);gap:8px;justify-content:flex-end}
    @media(max-width:768px){.phone-bar{display:flex}}
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:199}
    .overlay.show{display:block}
    .mob-sheet{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg2);
               border-top:1px solid var(--b2);border-radius:18px 18px 0 0;
               padding:12px 18px 24px;z-index:200;transform:translateY(100%);
               transition:transform .28s cubic-bezier(.4,0,.2,1)}
    .mob-sheet.open{transform:translateY(0)}
    @media(max-width:768px){.mob-sheet{display:block}}
    .sheet-handle{width:32px;height:4px;border-radius:2px;background:var(--b2);margin:0 auto 12px}
    .tbtn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;
          border:1px solid var(--b1);background:var(--bg2);color:var(--t2);
          font-family:var(--sans);font-size:12px;font-weight:500;cursor:pointer;
          transition:background .12s,border-color .12s,color .12s}
    .tbtn:hover{background:var(--bg3);border-color:var(--b2);color:var(--t1)}
    .tbtn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  </style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="shell">

  <!-- HEADER -->
  <header role="banner">
    <div class="logo">
      <div class="logo-icon" aria-hidden="true">
        <!-- Brain/finance icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round">
          <path d="M12 2a4 4 0 0 1 4 4c0 1-.3 2-.9 2.7A4 4 0 0 1 16 12a4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 .9-2.5A4 4 0 0 1 8 6a4 4 0 0 1 4-4z"/>
          <line x1="12" y1="16" x2="12" y2="22"/>
          <line x1="9" y1="19" x2="15" y2="19"/>
        </svg>
      </div>
      <span class="logo-name">Sentience</span>
      <span class="logo-tagline" aria-hidden="true">Financial Conscience</span>
      <span class="logo-badge">v1</span>
    </div>
    <div class="hdr-r">
      <div class="status-pill" id="statusPill" role="status" aria-live="polite" aria-label="Connection status">
        <span class="sdot" aria-hidden="true"></span>
        <span id="statusTxt">Connecting‚Ä¶</span>
      </div>
    </div>
  </header>

  <main id="main-content">

    <!-- HISTORY SIDEBAR -->
    <nav class="hist-sidebar" aria-label="Chat history">
      <div class="hist-top">
        <div class="hist-heading">History</div>
        <button class="new-chat-btn" id="newChatBtn" aria-label="Start new chat">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Chat
        </button>
      </div>
      <div class="hist-list" id="histList">
        <div style="padding:16px 10px;font-size:11px;font-family:var(--mono);color:var(--t3);display:flex;align-items:center;gap:6px">
          <div style="width:13px;height:13px;border-radius:50%;border:2px solid var(--b2);border-top-color:var(--accent)"></div>
          Loading‚Ä¶
        </div>
      </div>
    </nav>

    <!-- CHAT PANEL -->
    <section class="chat-panel" aria-label="Conversation">
      <div class="chat-titlebar">
        <span class="chat-session-title" id="chatTitle">New conversation</span>
        <span class="chat-session-id" id="chatSessId">‚Äî</span>
      </div>

      <!-- Tab row -->
      <div class="tab-row" role="tablist">
        <button class="tab-btn active" id="tabChat" role="tab" aria-selected="true"
                aria-controls="panelChat" onclick="switchTab('chat')">üí¨ Chat</button>
        <button class="tab-btn" id="tabLedger" role="tab" aria-selected="false"
                aria-controls="panelLedger" onclick="switchTab('ledger')">üìä Psychological Ledger</button>
      </div>

      <!-- Chat tab -->
      <div class="tab-panel show" id="panelChat" role="tabpanel">
        <div id="chatArea" role="log" aria-live="polite" aria-label="Conversation messages">
          <div class="empty-state" id="emptyState">
            <div class="empty-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                <path d="M12 2a4 4 0 0 1 4 4c0 1-.3 2-.9 2.7A4 4 0 0 1 16 12a4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 .9-2.5A4 4 0 0 1 8 6a4 4 0 0 1 4-4z"/>
                <line x1="12" y1="16" x2="12" y2="22"/>
              </svg>
            </div>
            <h2>Your financial conscience</h2>
            <p>Talk about money. Sentience notices patterns between your emotions and your spending.</p>
          </div>
        </div>

        <!-- INPUT BAR -->
        <div class="input-bar" role="form" aria-label="Message input">
          <div class="voice-ind" id="voiceInd" aria-live="assertive" aria-label="Microphone recording">
            <div style="display:flex;gap:2px;align-items:center" aria-hidden="true">
              <div style="width:2px;height:4px;background:var(--red);border-radius:2px"></div>
              <div style="width:2px;height:9px;background:var(--red);border-radius:2px"></div>
              <div style="width:2px;height:12px;background:var(--red);border-radius:2px"></div>
              <div style="width:2px;height:9px;background:var(--red);border-radius:2px"></div>
              <div style="width:2px;height:4px;background:var(--red);border-radius:2px"></div>
            </div>
            Listening‚Ä¶
          </div>
          <div class="tone-row" role="group" aria-label="Select emotional tone">
            <span class="tone-label">Mood</span>
            <button class="tone-chip active" data-emotion="neutral"    onclick="setEmotion(this,'neutral')">üòê Neutral</button>
            <button class="tone-chip"        data-emotion="stressed"   onclick="setEmotion(this,'stressed')">üò∞ Stressed</button>
            <button class="tone-chip"        data-emotion="frustrated" onclick="setEmotion(this,'frustrated')">üò§ Frustrated</button>
            <button class="tone-chip"        data-emotion="sad"        onclick="setEmotion(this,'sad')">üòî Sad</button>
            <button class="tone-chip"        data-emotion="happy"      onclick="setEmotion(this,'happy')">üòä Happy</button>
            <button class="tone-chip"        data-emotion="anxious"    onclick="setEmotion(this,'anxious')">üòü Anxious</button>
          </div>
          <div class="inp-row">
            <textarea id="userInput" placeholder="Tell Sentience what's on your mind‚Ä¶" rows="1"
                      aria-label="Message input" maxlength="2000"></textarea>
            <button id="micBtn" aria-label="Toggle microphone" aria-pressed="false" title="Voice input">
              <svg style="width:18px;height:18px;pointer-events:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="2" width="6" height="12" rx="3"/>
                <path d="M5 10a7 7 0 0 0 14 0"/>
                <line x1="12" y1="19" x2="12" y2="22"/>
                <line x1="9" y1="22" x2="15" y2="22"/>
              </svg>
            </button>
            <button id="sendBtn" aria-label="Send message" disabled>Send</button>
          </div>
          <div class="tool-row">
            <span class="hint-txt">Enter to send ¬∑ Shift+Enter for new line ¬∑ Esc stops mic</span>
            <div style="display:flex;gap:8px;align-items:center">
              <span class="cc" id="charCount" aria-label="Character count">0 / 2000</span>
              <button id="resetBtn" class="reset-btn" aria-label="Reset conversation">‚Ü∫ reset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ledger tab -->
      <div class="tab-panel" id="panelLedger" role="tabpanel">
        <div class="ledger-panel" id="ledgerContent">
          <div class="ledger-empty">
            <span style="font-size:32px">üìä</span>
            <p>No spending data yet.<br>Log your first expense in the sidebar to see your Psychological Ledger.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT SIDEBAR -->
    <aside class="right-sidebar" aria-label="Camera, emotion, and spending">

      <div class="rs-sec">
        <div class="rs-label">Vision Context</div>
        <div class="vis-card">
          <div class="vis-card-head">
            <span class="vis-card-title">Camera</span>
            <button class="toggle" id="camToggle" aria-label="Toggle camera" aria-pressed="false"></button>
          </div>
          <div class="cam-wrap">
            <video id="videoFeed" autoplay muted playsinline aria-label="Camera feed"></video>
            <div class="cam-off" id="camOff">
              <div class="cam-off-icon" aria-hidden="true">
                <svg style="width:28px;height:28px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                  <path d="M15 10l4.553-2.276A1 1 0 0121 8.723v6.554a1 1 0 01-1.447.894L15 14M3 8a2 2 0 012-2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/>
                  <line x1="3" y1="3" x2="21" y2="21"/>
                </svg>
              </div>
              <span class="cam-off-txt">Camera off</span>
            </div>
          </div>
          <div class="vis-reading">
            <div class="vis-reading-lbl">Reading</div>
            <div class="vis-reading-val" id="visCtx">Enable camera to detect emotion</div>
          </div>
        </div>
      </div>

      <div class="rs-sec">
        <div class="rs-label">Emotional State</div>
        <div class="emo-row">
          <div class="emo-orb" id="emoOrb" role="img" aria-label="Detected emotion">üòê</div>
          <div>
            <div class="emo-name" id="emoName">Neutral</div>
            <div class="emo-sub"  id="emoSub">No camera data</div>
          </div>
        </div>
      </div>

      <div class="rs-sec">
        <div class="rs-label">Log a Spend</div>
        <div class="spend-form">
          <div class="sf-row">
            <input type="number" id="spendAmt" class="sf-input small" placeholder="$0.00"
                   min="0.01" step="0.01" aria-label="Amount in dollars"/>
            <select id="spendCat" class="sf-input" aria-label="Spending category">
              <option>Food &amp; Dining</option>
              <option>Shopping</option>
              <option>Entertainment</option>
              <option>Travel</option>
              <option>Health</option>
              <option>Technology</option>
              <option>Subscriptions</option>
              <option>Other</option>
            </select>
          </div>
          <input type="text" id="spendDesc" class="sf-input" placeholder="What was it? (optional)"
                 aria-label="Spend description" maxlength="120"/>
          <button class="log-btn" id="logSpendBtn" aria-label="Log this expense">Log Expense</button>
          <div class="log-feedback" id="logFeedback" aria-live="polite"></div>
        </div>
      </div>

      <div class="rs-sec">
        <div class="rs-label">Session</div>
        <div class="mem-row">
          <div class="mem-card"><div class="mem-num" id="turnNum">0</div><div class="mem-lbl">Turns</div></div>
          <div class="mem-card"><div class="mem-num" id="totalSpend">$0</div><div class="mem-lbl">Logged</div></div>
        </div>
      </div>

      <div class="rs-sec">
        <div class="rs-label">Shortcuts</div>
        <div class="kbd-list">
          <div class="kbd-row"><span>Send</span><div class="keys"><span class="key">Enter</span></div></div>
          <div class="kbd-row"><span>New line</span><div class="keys"><span class="key">Shift</span><span class="key">Enter</span></div></div>
          <div class="kbd-row"><span>Stop mic</span><div class="keys"><span class="key">Esc</span></div></div>
        </div>
      </div>

    </aside>
  </main>

  <!-- Mobile bar -->
  <div class="phone-bar" id="phoneBar">
    <button class="tbtn" id="histMobBtn" aria-label="View history">üìã History</button>
    <button class="tbtn" id="logMobBtn"  aria-label="Log expense">üí∞ Log</button>
    <button class="tbtn" id="camMobBtn"  aria-label="Camera">üì∑ Camera</button>
  </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Mobile sheets -->
<div class="mob-sheet" id="histMobSheet" role="dialog" aria-label="Chat history">
  <div class="sheet-handle"></div>
  <div style="font-size:14px;font-weight:600;color:var(--t1);margin-bottom:10px">History</div>
  <button class="new-chat-btn" id="newChatBtnMob" style="margin-bottom:8px;justify-content:center">+ New Chat</button>
  <div id="histListMob" style="max-height:55vh;overflow-y:auto"></div>
  <button class="tbtn" id="closeHistSheet" style="width:100%;justify-content:center;margin-top:8px">‚úï Close</button>
</div>

<div class="mob-sheet" id="logMobSheet" role="dialog" aria-label="Log expense">
  <div class="sheet-handle"></div>
  <div style="font-size:14px;font-weight:600;color:var(--t1);margin-bottom:12px">Log a Spend</div>
  <div class="spend-form">
    <div class="sf-row">
      <input type="number" id="spendAmtM" class="sf-input small" placeholder="$0.00" min="0.01" step="0.01"/>
      <select id="spendCatM" class="sf-input">
        <option>Food &amp; Dining</option><option>Shopping</option><option>Entertainment</option>
        <option>Travel</option><option>Health</option><option>Technology</option>
        <option>Subscriptions</option><option>Other</option>
      </select>
    </div>
    <input type="text" id="spendDescM" class="sf-input" placeholder="What was it?" maxlength="120"/>
    <button class="log-btn" id="logSpendBtnM">Log Expense</button>
    <div class="log-feedback" id="logFeedbackM" aria-live="polite"></div>
  </div>
  <button class="tbtn" id="closeLogSheet" style="width:100%;justify-content:center;margin-top:8px">‚úï Close</button>
</div>

<!-- INTERVENTION MODAL -->
<div class="modal-backdrop" id="interventionModal" role="alertdialog"
     aria-labelledby="modalTitle" aria-describedby="modalBody">
  <div class="modal">
    <span class="modal-icon" aria-hidden="true">‚ö†Ô∏è</span>
    <div class="modal-title" id="modalTitle">Wait a moment.</div>
    <div class="modal-body" id="modalBody">
      <!-- filled dynamically -->
    </div>
    <div class="modal-actions">
      <button class="modal-dismiss" id="modalDismiss">I'll wait 24h ‚úì</button>
      <button class="modal-log-anyway" id="modalLogAnyway">Log it anyway</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONFIG
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = (location.hostname==='localhost'||location.hostname==='127.0.0.1')
  ? 'http://localhost:8000'
  : 'https://YOUR-CLOUD-RUN-URL.a.run.app';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cameraOn=false, micOn=false, sending=false;
let stream=null, recog=null, emotion='neutral';
let frame='', frameInt=null, turns=0;
let inactTmr=null, curSessId=null, curTitle='New conversation';
let totalSpendLogged=0;
let pendingSpendData=null; // holds data when intervention modal is shown

const EMOS={
  happy:{e:'üòä',l:'Happy'}, sad:{e:'üòî',l:'Sad'},
  frustrated:{e:'üò§',l:'Frustrated'}, angry:{e:'üò†',l:'Angry'},
  confused:{e:'üòï',l:'Confused'}, neutral:{e:'üòê',l:'Neutral'},
  stressed:{e:'üò∞',l:'Stressed'}, fearful:{e:'üò®',l:'Fearful'},
  anxious:{e:'üòü',l:'Anxious'}, calm:{e:'üòå',l:'Calm'},
  tired:{e:'üò¥',l:'Tired'}, lonely:{e:'ü•∫',l:'Lonely'},
};

const $=id=>document.getElementById(id);
const chatArea=$('chatArea'), empty=$('emptyState'), inp=$('userInput');
const sendBtn=$('sendBtn'), micBtn=$('micBtn');
const camToggle=$('camToggle');
const vid=$('videoFeed'), camOff=$('camOff');
const eoOrb=$('emoOrb'), eoName=$('emoName'), eoSub=$('emoSub');
const visCtx=$('visCtx'), cc=$('charCount'), voiceInd=$('voiceInd');
const statusPill=$('statusPill'), statusTxt=$('statusTxt');
const turnNum=$('turnNum'), totalSpendEl=$('totalSpend');
const chatTitle=$('chatTitle'), chatSessId=$('chatSessId');
const histList=$('histList'), histListMob=$('histListMob');
const overlay=$('overlay'), modal=$('interventionModal');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TABS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(t){
  $('tabChat').classList.toggle('active',t==='chat');
  $('tabLedger').classList.toggle('active',t==='ledger');
  $('tabChat').setAttribute('aria-selected',t==='chat');
  $('tabLedger').setAttribute('aria-selected',t==='ledger');
  $('panelChat').classList.toggle('show',t==='chat');
  $('panelLedger').classList.toggle('show',t==='ledger');
  if(t==='ledger') loadLedger();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATUS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkStatus(){
  try{
    const d=await(await fetch(`${API}/health`,{signal:AbortSignal.timeout(4000)})).json();
    statusPill.className='status-pill online'; statusTxt.textContent='Connected';
    if(d.session_id){ curSessId=d.session_id; chatSessId.textContent='#'+d.session_id.slice(-6); }
  }catch{
    statusPill.className='status-pill offline'; statusTxt.textContent='Offline';
    setTimeout(checkStatus,5000);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INACTIVITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetInact(){
  clearTimeout(inactTmr);
  inactTmr=setTimeout(async()=>{
    try{
      const d=await(await fetch(`${API}/check-in`)).json();
      if(d.message) addMsg(d.message,'proactive');
    }catch{}
  },30_000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HISTORY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHistory(){
  try{
    const d=await(await fetch(`${API}/sessions`)).json();
    renderHist(d.sessions||[], histList);
    renderHist(d.sessions||[], histListMob);
  }catch{
    const m='<div class="hist-empty">History unavailable.</div>';
    histList.innerHTML=m; histListMob.innerHTML=m;
  }
}

function renderHist(sessions, container){
  if(!sessions.length){
    container.innerHTML='<div class="hist-empty">No conversations yet.</div>'; return;
  }
  container.innerHTML='';
  const now=new Date(), groups={Today:[],Yesterday:[],Older:[]};
  sessions.forEach(s=>{
    const d=s.last_active?new Date(s.last_active):null;
    if(!d){groups.Older.push(s);return;}
    const diff=Math.floor((now-d)/86400000);
    if(diff===0) groups.Today.push(s);
    else if(diff===1) groups.Yesterday.push(s);
    else groups.Older.push(s);
  });
  Object.entries(groups).forEach(([label,items])=>{
    if(!items.length) return;
    const lbl=document.createElement('div');
    lbl.className='hist-date-label'; lbl.textContent=label;
    container.appendChild(lbl);
    items.forEach(s=>container.appendChild(makeHistItem(s)));
  });
}

function makeHistItem(s){
  const item=document.createElement('div');
  item.className='hist-item'+(s.id===curSessId?' active':'');
  item.setAttribute('role','button'); item.setAttribute('tabindex','0');
  item.setAttribute('aria-label','Load: '+(s.title||'Untitled'));
  const title=document.createElement('div');
  title.className='hi-title'; title.textContent=s.title||'Untitled';
  const meta=document.createElement('div');
  meta.className='hi-meta'; meta.textContent=(s.total_turns||0)+' turns';
  item.appendChild(title); item.appendChild(meta);
  const load=async()=>{ closeAllSheets(); await loadSessIntoChat(s.id,s.title||'Untitled'); };
  item.addEventListener('click',load);
  item.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' ')load();});
  return item;
}

async function loadSessIntoChat(sid,title){
  clearChat(); addMsg('Loading‚Ä¶','proactive');
  try{
    const [,turnsRes]=await Promise.all([
      fetch(`${API}/sessions/${sid}/load`,{method:'POST'}),
      fetch(`${API}/sessions/${sid}/turns`).then(r=>r.json()),
    ]);
    clearChat();
    const tlist=turnsRes.turns||[];
    if(!tlist.length){ addMsg('This conversation is empty.','proactive'); }
    else{
      const div=document.createElement('div');
      div.className='hist-divider'; div.textContent='Loaded: '+title;
      chatArea.insertBefore(div,empty); empty.style.display='none';
      tlist.forEach(t=>{
        if(t.user_message) addMsg(t.user_message,'user');
        if(t.ai_response){
          const vc=t.visual_context&&!t.visual_context.includes('unavailable')
            &&!t.visual_context.includes('unclear')?t.visual_context:null;
          const type=t.intervention_triggered?'intervention':'ai';
          addMsgBadge(t.ai_response,type,vc,t.emotion_hint);
        }
      });
    }
    curSessId=sid; curTitle=title;
    chatTitle.textContent=title;
    chatSessId.textContent='#'+sid.slice(-6);
    turns=tlist.length;
    turnNum.textContent=turns;
    document.querySelectorAll('.hist-item').forEach(el=>
      el.classList.toggle('active',el.getAttribute('aria-label')==='Load: '+title));
  }catch{ clearChat(); addMsg('Could not load this conversation.','ai'); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MESSAGES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty(){ empty.style.display='none'; }
function clearChat(){
  chatArea.innerHTML=''; chatArea.appendChild(empty);
  empty.style.display=''; turns=0; turnNum.textContent='0';
}

function addMsg(text,type='ai',meta=''){
  hideEmpty();
  const labels={ai:'Sentience',user:'You',safety:'‚ö†Ô∏è Sentience',
                proactive:'üíô Sentience',intervention:'‚ö†Ô∏è Sentience'};
  const block=document.createElement('div');
  block.className='msg-block '+type;
  const lbl=document.createElement('div');
  lbl.className='msg-label'; lbl.setAttribute('aria-hidden','true');
  lbl.textContent=labels[type]||'Sentience';
  const bub=document.createElement('div');
  bub.className='msg-bubble'; bub.textContent=text;
  block.appendChild(lbl); block.appendChild(bub);
  if(meta){ const m=document.createElement('div'); m.className='msg-meta';
            m.textContent=meta; m.setAttribute('aria-hidden','true'); block.appendChild(m); }
  chatArea.appendChild(block); chatArea.scrollTop=chatArea.scrollHeight;
}

function addMsgBadge(text,type,visualCtx,emotionHint){
  hideEmpty();
  const labels={ai:'Sentience',user:'You',safety:'‚ö†Ô∏è Sentience',
                proactive:'üíô Sentience',intervention:'‚ö†Ô∏è Sentience'};
  const block=document.createElement('div');
  block.className='msg-block '+type;
  const lbl=document.createElement('div');
  lbl.className='msg-label'; lbl.setAttribute('aria-hidden','true');
  lbl.textContent=labels[type]||'Sentience';
  const bub=document.createElement('div');
  bub.className='msg-bubble'; bub.textContent=text;
  block.appendChild(lbl); block.appendChild(bub);
  if(visualCtx){
    const badge=document.createElement('div'); badge.className='emo-badge';
    const key=Object.keys(EMOS).find(k=>visualCtx.toLowerCase().includes(k));
    badge.textContent=(key?EMOS[key].e+' ':'üëÅ ')+visualCtx;
    block.appendChild(badge);
  } else if(emotionHint&&emotionHint!=='neutral'){
    const badge=document.createElement('div'); badge.className='emo-badge';
    const e=EMOS[emotionHint];
    badge.textContent=(e?e.e+' ':'')+emotionHint;
    block.appendChild(badge);
  }
  chatArea.appendChild(block); chatArea.scrollTop=chatArea.scrollHeight;
}

function showTyping(){
  hideEmpty();
  const block=document.createElement('div');
  block.className='typing-block'; block.id='typBlock';
  block.setAttribute('role','status'); block.setAttribute('aria-label','Sentience is typing');
  const lbl=document.createElement('div'); lbl.className='typing-label';
  lbl.setAttribute('aria-hidden','true'); lbl.textContent='Sentience';
  const bub=document.createElement('div'); bub.className='typing-bub';
  bub.innerHTML='<span></span><span></span><span></span>';
  block.appendChild(lbl); block.appendChild(bub);
  chatArea.appendChild(block); chatArea.scrollTop=chatArea.scrollHeight;
}
function hideTyping(){ $('typBlock')?.remove(); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SEND
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function send(){
  const text=inp.value.trim();
  if(!text||sending) return;
  if(cameraOn) captureFrame();

  sending=true; sendBtn.disabled=true;
  const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  addMsg(text,'user',t);
  inp.value=''; inp.style.height='auto'; updateCC();
  resetInact(); showTyping();

  try{
    const res=await fetch(`${API}/speak`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text,emotion_hint:emotion,image_frame:frame}),
    });
    hideTyping();
    if(!res.ok){ addMsg('Connection issue ‚Äî please try again.','ai'); return; }
    const d=await res.json();

    const type=d.status==='safety_intercept'?'safety':d.intervention?'intervention':'ai';
    const vc=d.visual_context&&!d.visual_context.includes('unavailable')
              &&!d.visual_context.includes('unclear')?d.visual_context:null;

    addMsgBadge(d.response,type,vc,emotion);

    // If intervention, also show the modal
    if(d.intervention){
      showInterventionModal(d.response, d.emotion_detected);
    }

    if(vc){
      visCtx.textContent=d.visual_context; visCtx.classList.add('active');
      updateEmo(null,d.visual_context);
    }
    if(d.session_title&&curTitle==='New conversation'){
      curTitle=d.session_title; chatTitle.textContent=d.session_title;
      setTimeout(loadHistory,500);
    }
    turns=d.turns??turns+1; turnNum.textContent=turns;
    if(d.session_id){ curSessId=d.session_id; chatSessId.textContent='#'+d.session_id.slice(-6); }
    resetInact();
  }catch{
    hideTyping(); addMsg('Connection issue ‚Äî is the backend running?','ai');
  }finally{
    sending=false; sendBtn.disabled=inp.value.trim().length===0;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INTERVENTION MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showInterventionModal(aiMessage, detectedEmotion){
  const emo=EMOS[detectedEmotion]||{e:'üòü',l:detectedEmotion};
  $('modalTitle').textContent='Wait a moment.';
  $('modalBody').innerHTML=
    `You seem <strong>${emo.e} ${emo.l}</strong> right now.<br><br>${aiMessage}<br><br>
     <strong>The 24-hour rule:</strong> If you still want this tomorrow, it's worth it.`;
  modal.classList.add('show');
  $('modalDismiss').focus();
}

$('modalDismiss').addEventListener('click',()=>{ modal.classList.remove('show'); });
$('modalLogAnyway').addEventListener('click',()=>{
  modal.classList.remove('show');
  addMsg("Alright ‚Äî I've noted you're proceeding. I'll check back on this one later.",'proactive');
});
modal.addEventListener('click',e=>{ if(e.target===modal) modal.classList.remove('show'); });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOG SPEND
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogSpend(amt, cat, desc, feedbackEl, btnEl){
  if(!amt||isNaN(parseFloat(amt))||parseFloat(amt)<=0){
    feedbackEl.textContent='Please enter a valid amount.'; return;
  }
  btnEl.disabled=true; feedbackEl.textContent='Logging‚Ä¶';
  try{
    const res=await fetch(`${API}/log-spend`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        amount:parseFloat(amt), category:cat,
        description:desc||'', emotion_hint:emotion,
        visual_context:visCtx.textContent||'',
      }),
    });
    const d=await res.json();
    if(d.status==='logged'){
      feedbackEl.textContent='‚úì '+d.ai_comment;
      totalSpendLogged+=parseFloat(amt);
      totalSpendEl.textContent='$'+totalSpendLogged.toFixed(0);
      // Add a chat message too
      addMsg(`Logged $${parseFloat(amt).toFixed(2)} on ${cat} while ${emotion}.`,'user');
      addMsg(d.ai_comment,'ai');
    } else {
      feedbackEl.textContent='Could not log ‚Äî check Firebase config.';
    }
  }catch{
    feedbackEl.textContent='Error logging spend.';
  }finally{
    btnEl.disabled=false;
  }
}

$('logSpendBtn').addEventListener('click',()=>{
  doLogSpend($('spendAmt').value, $('spendCat').value,
             $('spendDesc').value, $('logFeedback'), $('logSpendBtn'));
});
$('logSpendBtnM').addEventListener('click',()=>{
  doLogSpend($('spendAmtM').value, $('spendCatM').value,
             $('spendDescM').value, $('logFeedbackM'), $('logSpendBtnM'));
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PSYCHOLOGICAL LEDGER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EMO_COLORS={
  frustrated:'#f87171', angry:'#ef4444', sad:'#60a5fa',
  stressed:'#fb923c', anxious:'#c084fc', lonely:'#a78bfa',
  happy:'#34d399', calm:'#6ee7b7', neutral:'#94a3b8',
  tired:'#fbbf24', fearful:'#f472b6', confused:'#67e8f9',
};

async function loadLedger(){
  const container=$('ledgerContent');
  container.innerHTML='<div class="ledger-empty"><p>Loading your data‚Ä¶</p></div>';
  try{
    const d=await(await fetch(`${API}/insights`)).json();
    if(!d.chart_data||!d.chart_data.length){
      container.innerHTML='<div class="ledger-empty"><span style="font-size:32px">üìä</span><p>No spending data yet.<br>Log your first expense in the sidebar.</p></div>';
      return;
    }
    renderLedger(d, container);
  }catch{
    container.innerHTML='<div class="ledger-empty"><p>Could not load insights.<br>Check backend connection.</p></div>';
  }
}

function renderLedger(d, container){
  container.innerHTML='';

  // AI Narrative
  const narCard=document.createElement('div'); narCard.className='ledger-card';
  narCard.innerHTML=`<div class="lc-title">üí° AI Insight</div>
    <div class="lc-narrative">${escHtml(d.narrative)}</div>`;
  container.appendChild(narCard);

  // Summary
  const topEmo=d.chart_data[0]||{};
  const sumCard=document.createElement('div'); sumCard.className='ledger-card';
  sumCard.innerHTML=`<div class="lc-title">Summary</div>
    <div class="sum-row">
      <div class="sum-card"><div class="sum-num">$${d.total_logged.toFixed(0)}</div><div class="sum-lbl">Total Logged</div></div>
      <div class="sum-card"><div class="sum-num">${d.chart_data.length}</div><div class="sum-lbl">Mood States</div></div>
      <div class="sum-card"><div class="sum-num">${(d.recent_spends||[]).length}</div><div class="sum-lbl">Transactions</div></div>
    </div>`;
  container.appendChild(sumCard);

  // Emotion bar chart ‚Äî the key visual
  const emoCard=document.createElement('div'); emoCard.className='ledger-card';
  emoCard.innerHTML=`<div class="lc-title">üß† Emotional Spending Map</div>
    <div class="chart-wrap" id="emoChart"></div>`;
  container.appendChild(emoCard);
  const maxTotal=Math.max(...d.chart_data.map(x=>x.total),1);
  const emoChart=emoCard.querySelector('#emoChart');
  d.chart_data.forEach(item=>{
    const pct=Math.max(4,Math.round((item.total/maxTotal)*100));
    const emoObj=EMOS[item.emotion]||{e:'‚Ä¢',l:item.emotion};
    const color=EMO_COLORS[item.emotion]||'#94a3b8';
    const row=document.createElement('div'); row.className='chart-row';
    row.innerHTML=`
      <div class="chart-label" title="${emoObj.l}">${emoObj.e} ${emoObj.l}</div>
      <div class="chart-bar-bg">
        <div class="chart-bar-fill" style="width:${pct}%;background:${color}"></div>
        <span class="chart-bar-text">$${item.total.toFixed(0)}</span>
      </div>
      <div class="chart-count">${item.count}√ó ${item.avg_regret!==null?'¬∑ '+item.avg_regret+'/10 regret':''}</div>`;
    emoChart.appendChild(row);
  });

  // Category chart
  if(d.category_data&&d.category_data.length){
    const catCard=document.createElement('div'); catCard.className='ledger-card';
    catCard.innerHTML=`<div class="lc-title">üìÇ Spending by Category</div>`;
    const maxCat=Math.max(...d.category_data.map(x=>x.total),1);
    d.category_data.forEach(item=>{
      const pct=Math.max(2,Math.round((item.total/maxCat)*100));
      const row=document.createElement('div'); row.className='cat-row';
      row.innerHTML=`<div class="cat-label">${escHtml(item.category)}</div>
        <div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${pct}%"></div></div>
        <div class="cat-amt">$${item.total.toFixed(0)}</div>`;
      catCard.appendChild(row);
    });
    container.appendChild(catCard);
  }

  // Recent spends table
  if(d.recent_spends&&d.recent_spends.length){
    const recCard=document.createElement('div'); recCard.className='ledger-card';
    recCard.innerHTML=`<div class="lc-title">üïê Recent Transactions</div>`;
    const table=document.createElement('table'); table.className='spend-table';
    table.innerHTML=`<thead><tr>
      <th>Amount</th><th>Category</th><th>Mood</th><th>Regret</th>
    </tr></thead>`;
    const tbody=document.createElement('tbody');
    d.recent_spends.forEach(sp=>{
      const emoObj=EMOS[sp.emotion]||{e:'‚Ä¢',l:sp.emotion};
      const regretCell=sp.regret_score!==null&&sp.regret_score!==undefined
        ? `<span class="regret-dot" style="background:${regretColor(sp.regret_score)}"></span>${sp.regret_score}/10`
        : `<button class="regret-ask-btn" onclick="askRegret('${escHtml(sp.spend_id)}',this)">Rate it</button>`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>$${sp.amount.toFixed(2)}</td>
        <td>${escHtml(sp.category)}</td>
        <td>${emoObj.e} ${emoObj.l}</td>
        <td>${regretCell}</td>`;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody); recCard.appendChild(table);
    container.appendChild(recCard);
  }
}

function regretColor(score){
  if(score<=3) return '#34d399';
  if(score<=6) return '#fbbf24';
  return '#f87171';
}

async function askRegret(spendId, btn){
  const score=parseInt(prompt('Rate your regret 0‚Äì10 (0 = no regret, 10 = full regret):'));
  if(isNaN(score)||score<0||score>10) return;
  try{
    await fetch(`${API}/regret`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({spend_id:spendId, regret_score:score}),
    });
    btn.parentElement.innerHTML=
      `<span class="regret-dot" style="background:${regretColor(score)}"></span>${score}/10`;
  }catch{ alert('Could not save regret score.'); }
}

function escHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INPUT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCC(){
  const l=inp.value.length;
  cc.textContent=l+' / 2000'; cc.className='cc'+(l>1800?' warn':'');
  sendBtn.disabled=l===0||sending;
}
inp.addEventListener('input',()=>{
  inp.style.height='auto';
  inp.style.height=Math.min(inp.scrollHeight,120)+'px';
  updateCC(); resetInact();
});
inp.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} });
sendBtn.addEventListener('click',send);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CAMERA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleCam(){ cameraOn?stopCam():await startCam(); }

async function startCam(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    vid.srcObject=stream;
    vid.onloadedmetadata=()=>vid.classList.add('live');
    camOff.classList.add('gone'); cameraOn=true;
    camToggle.classList.add('on'); camToggle.setAttribute('aria-pressed','true');
    eoSub.textContent='Camera active';
    captureFrame();
    frameInt=setInterval(captureFrame,3000);
  }catch{ addMsg('Camera access denied ‚Äî mood detection will use your selected tone only.','ai'); }
}

function stopCam(){
  stream?.getTracks().forEach(t=>t.stop()); stream=null;
  vid.srcObject=null; vid.classList.remove('live');
  camOff.classList.remove('gone'); cameraOn=false; frame='';
  camToggle.classList.remove('on'); camToggle.setAttribute('aria-pressed','false');
  eoOrb.classList.remove('detected');
  eoSub.textContent='Camera off';
  visCtx.textContent='Enable camera to detect emotion';
  visCtx.classList.remove('active');
  clearInterval(frameInt); frameInt=null;
}

function captureFrame(){
  if(!cameraOn||!vid.videoWidth) return;
  const c=document.createElement('canvas');
  c.width=320; c.height=240;
  c.getContext('2d').drawImage(vid,0,0,320,240);
  frame=c.toDataURL('image/jpeg',.7).split(',')[1];
}

camToggle.addEventListener('click',toggleCam);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EMOTION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setEmotion(btn,key){
  document.querySelectorAll('.tone-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active'); emotion=key;
  if(EMOS[key]){
    eoOrb.textContent=EMOS[key].e; eoName.textContent=EMOS[key].l;
    eoSub.textContent='Manual selection';
  }
}

function updateEmo(key,visual){
  if(visual){
    const lo=visual.toLowerCase();
    for(const k of Object.keys(EMOS)){ if(lo.includes(k)){key=k;break;} }
    eoSub.textContent='From camera';
  }
  if(key&&EMOS[key]){
    emotion=key;
    eoOrb.textContent=EMOS[key].e; eoName.textContent=EMOS[key].l;
    eoOrb.classList.add('detected');
    document.querySelectorAll('.tone-chip').forEach(c=>
      c.classList.toggle('active',c.dataset.emotion===key));
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MIC ‚Äî fixed
//  Bugs fixed:
//  1. onend called stopMic() which called recog.stop() on already-ended recogniser
//     ‚Üí Chrome fired a second onend ‚Üí send never ran
//  2. onerror silently swallowed all failures
//  3. interimResults:true meant final text wasn't always settled before send
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMic(){ micOn ? stopMic(true) : startMic(); }

function startMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    addMsg('Speech recognition requires Chrome or Edge ‚Äî Firefox does not support it yet.','ai');
    return;
  }
  // Guard: don't start twice
  if(micOn) return;

  recog = new SR();
  recog.continuous     = false;   // single utterance
  recog.interimResults = true;    // show live transcript in input
  recog.lang           = 'en-US';

  recog.onstart = () => {
    micOn = true;
    micBtn.setAttribute('aria-pressed','true');
    micBtn.classList.add('rec');
    voiceInd.classList.add('on');
  };

  // Live preview in textarea while speaking
  recog.onresult = e => {
    let interim = '', finalTxt = '';
    for(const result of e.results){
      if(result.isFinal) finalTxt += result[0].transcript;
      else interim += result[0].transcript;
    }
    inp.value = finalTxt || interim;
    updateCC();
  };

  // onend fires when recognition stops naturally (after silence or .stop())
  // CRITICAL: do NOT call recog.stop() here ‚Äî it already stopped.
  // Calling stop() on ended recogniser triggers a second onend ‚Üí infinite loop.
  recog.onend = () => {
    const textToSend = inp.value.trim();
    // Clean up state directly ‚Äî do NOT call stopMic() which calls recog.stop()
    micOn = false;
    recog = null;
    micBtn.setAttribute('aria-pressed','false');
    micBtn.classList.remove('rec');
    voiceInd.classList.remove('on');
    // Auto-send if we captured something
    if(textToSend) send();
  };

  recog.onerror = e => {
    const msgs = {
      'not-allowed':  'Microphone permission denied ‚Äî please allow mic access in your browser.',
      'no-speech':    'No speech detected ‚Äî try speaking closer to your mic.',
      'network':      'Network error during speech recognition ‚Äî check your connection.',
      'aborted':      '',   // user cancelled, silent
      'audio-capture':'No microphone found ‚Äî check your device settings.',
      'service-not-allowed': 'Speech service blocked ‚Äî try on a live server (not file://).',
    };
    const msg = msgs[e.error];
    if(msg) addMsg(msg,'ai');
    // Clean up state directly ‚Äî don't call stopMic() which would call recog.stop() again
    micOn = false; recog = null;
    micBtn.setAttribute('aria-pressed','false');
    micBtn.classList.remove('rec');
    voiceInd.classList.remove('on');
  };

  recog.start();
}

// stopMic called by user (Esc or button click while recording)
function stopMic(userTriggered = false){
  if(recog){
    recog.onend = null;   // prevent auto-send on manual stop
    recog.onerror = null;
    try{ recog.stop(); } catch(e){}
    recog = null;
  }
  micOn = false;
  micBtn.setAttribute('aria-pressed','false');
  micBtn.classList.remove('rec');
  voiceInd.classList.remove('on');
}

micBtn.addEventListener('click',toggleMic);
document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&micOn) stopMic(true); });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RESET / NEW CHAT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startNewChat(){
  try{
    const d=await(await fetch(`${API}/reset`,{method:'POST'})).json();
    clearChat(); inp.value=''; updateCC();
    emotion='neutral'; frame=''; curTitle='New conversation';
    chatTitle.textContent='New conversation';
    visCtx.textContent='Enable camera to detect emotion';
    visCtx.classList.remove('active');
    eoOrb.textContent='üòê'; eoName.textContent='Neutral';
    eoSub.textContent='No camera data';
    eoOrb.classList.remove('detected');
    document.querySelectorAll('.tone-chip').forEach(c=>c.classList.toggle('active',c.dataset.emotion==='neutral'));
    document.querySelectorAll('.hist-item').forEach(i=>i.classList.remove('active'));
    if(d.new_session_id){ curSessId=d.new_session_id; chatSessId.textContent='#'+d.new_session_id.slice(-6); }
    setTimeout(loadHistory,300);
  }catch{ addMsg('Reset failed ‚Äî please try again.','ai'); }
}

$('resetBtn').addEventListener('click',startNewChat);
$('newChatBtn').addEventListener('click',startNewChat);
$('newChatBtnMob').addEventListener('click',startNewChat);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MOBILE SHEETS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSheet(sheet){ sheet.classList.add('open'); overlay.classList.add('show'); }
function closeAllSheets(){
  [$('histMobSheet'),$('logMobSheet')].forEach(s=>s.classList.remove('open'));
  overlay.classList.remove('show');
}
$('histMobBtn').addEventListener('click',()=>openSheet($('histMobSheet')));
$('logMobBtn').addEventListener('click', ()=>openSheet($('logMobSheet')));
$('camMobBtn').addEventListener('click', ()=>toggleCam());
overlay.addEventListener('click',closeAllSheets);
$('closeHistSheet').addEventListener('click',closeAllSheets);
$('closeLogSheet').addEventListener('click',closeAllSheets);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async()=>{
  await checkStatus();
  await loadHistory();
  inp.addEventListener('focus',resetInact,{once:true});
})();
</script>
</body>
</html>